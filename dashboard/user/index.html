<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>داشبورد کاربری | Pro TooLs</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    .user-dashboard { 
      max-width: 1200px; 
      margin: 24px auto; 
      padding: 0 16px;
      min-height: calc(100vh - 100px);
    }
    
    .user-header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 16px; 
      margin-bottom: 32px;
      padding: 24px;
      background: var(--surface);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border);
      backdrop-filter: blur(20px);
    }
    
    .user-title { 
      font-size: 2rem; 
      font-weight: 800; 
      color: var(--text);
      margin: 0;
    }
    
    .user-subtitle {
      color: var(--text-muted);
      font-size: 1rem;
      margin-top: 4px;
    }
    
    .plan-badge { 
      display: inline-flex; 
      align-items: center; 
      gap: 8px; 
      padding: 12px 16px; 
      border-radius: var(--radius-full); 
      border: 2px solid var(--border); 
      background: var(--surface-strong);
      font-weight: 700;
      font-size: 0.9rem;
      transition: all var(--duration-normal) ease;
    }
    
    .plan-free { 
      color: var(--text-muted);
      border-color: var(--border-strong);
    }
    
    .plan-gold { 
      color: #ffd54f; 
      border-color: rgba(255,213,79,.6); 
      background: rgba(255,213,79,.1);
      box-shadow: 0 0 20px rgba(255,213,79,.2);
    }
    
    .grid { 
      display: grid; 
      grid-template-columns: 2fr 1fr; 
      gap: 24px;
      margin-bottom: 24px;
    }
    
    @media (max-width: 900px) { 
      .grid { grid-template-columns: 1fr; }
      .user-header { flex-direction: column; text-align: center; }
    }
    
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: 24px;
      backdrop-filter: blur(20px);
      transition: all var(--duration-normal) ease;
      position: relative;
      overflow: hidden;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--text);
      opacity: 0;
      transition: opacity var(--duration-normal) ease;
    }
    
    .card:hover::before {
      opacity: 1;
    }
    
    .card:hover {
      background: var(--surface-strong);
      border-color: var(--text);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .card-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .card-icon {
      width: 24px;
      height: 24px;
      opacity: 0.7;
    }
    
    .card .muted { 
      color: var(--text-muted);
      line-height: 1.6;
    }
    
    .favorites-empty { 
      text-align: center; 
      color: var(--text-muted); 
      padding: 32px 16px;
      background: var(--surface);
      border-radius: var(--radius-lg);
      border: 2px dashed var(--border);
    }
    
    .favorite-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
      transition: all var(--duration-normal) ease;
    }
    
    .favorite-item:hover {
      background: var(--surface-hover);
      border-color: var(--border-hover);
    }
    
    .favorite-title {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .favorite-type {
      font-size: 0.8rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .remove-favorite {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      border-radius: var(--radius-sm);
      transition: all var(--duration-fast) ease;
    }
    
    .remove-favorite:hover {
      color: var(--error);
      background: rgba(var(--error-rgb), 0.1);
    }
    
    .kv { 
      font-family: ui-monospace, Menlo, Consolas, "Courier New", monospace; 
      color: var(--text-muted); 
      font-size: 0.85rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 16px;
      overflow-x: auto;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
      margin: 16px 0;
    }
    
    .stat-item {
      text-align: center;
      padding: 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
    }
    
    .stat-number {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
  </style>
</head>
<body>
  <div id="main" class="user-dashboard">
    <div class="user-header">
      <div>
        <div class="user-title">داشبورد کاربری</div>
        <div id="userMeta" class="user-subtitle">در حال بارگذاری...</div>
      </div>
      <div style="display:flex; gap:12px; align-items:center; flex-wrap: wrap;">
        <a class="btn btn-secondary" href="/">بازگشت به سایت</a>
        <div id="planBadge" class="plan-badge plan-free">طرح: رایگان</div>
      </div>
    </div>

    <!-- آمار کاربر -->
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-number" id="favoritesCount">0</div>
        <div class="stat-label">علاقه‌مندی</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="downloadsCount">0</div>
        <div class="stat-label">دانلود</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="articlesRead">0</div>
        <div class="stat-label">مقاله خوانده شده</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="memberSince">-</div>
        <div class="stat-label">عضویت از</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3 class="card-title">
          <svg class="card-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 6h16v12H4z"/>
          </svg>
          سرورهای من (DNS)
        </h3>
        <div id="myServersEmpty" class="favorites-empty" style="display:none;">
          <div style="margin-bottom:8px;">هنوز سروری دریافت نکرده‌اید</div>
          <div class="muted" style="margin-bottom:12px;">از بخش «دی ان اس (DNS)» یک سرور دریافت کنید تا اینجا نمایش داده شود.</div>
          <a class="btn btn-primary" href="/Pages/dns.html">رفتن به صفحه DNS</a>
        </div>
        <div id="myServersList"></div>
        <div style="margin-top:16px; display:flex; gap:8px;">
          <button id="refreshServers" class="btn btn-outline">به‌روزرسانی سرورها</button>
          <a class="btn btn-secondary" href="/Pages/dns.html">دریافت سرور جدید</a>
        </div>
      </div>

      <div class="card">
        <h3 class="card-title">
          <svg class="card-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
          </svg>
          علاقه‌مندی‌ها
        </h3>
        <div id="favorites" class="favorites-empty">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="margin-bottom: 16px; opacity: 0.5;">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
          </svg>
          <div>هنوز موردی به علاقه‌مندی‌ها اضافه نکرده‌اید</div>
          <div class="muted" style="margin-top: 8px; font-size: 0.9rem;">مقالات و کانفیگ‌های مورد علاقه خود را ذخیره کنید</div>
        </div>
        <div id="favoritesList"></div>
      </div>

      <div class="card">
        <h3 class="card-title">
          <svg class="card-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          فعال‌سازی حساب طلایی
        </h3>
        <p class="muted">اگر کد فعال‌سازی دارید، وارد کنید تا حسابتان به طلایی ارتقا یابد.</p>
        <div style="display:flex; gap:12px; align-items:center; flex-wrap: wrap;">
          <input id="goldCode" class="input" placeholder="کد طلایی" style="flex: 1; min-width: 200px;" />
          <button id="btnActivateGold" class="btn btn-primary">فعال‌سازی</button>
        </div>
        <div id="goldMsg" class="muted" style="margin-top:12px;"></div>
        
        <div class="muted" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
          <strong>مزایای حساب طلایی:</strong>
          <ul style="margin: 8px 0; padding-right: 20px;">
            <li>دسترسی به تمام مقالات پیشرفته</li>
            <li>دانلود نامحدود کانفیگ‌ها</li>
            <li>پشتیبانی اولویت‌دار</li>
            <li>به‌روزرسانی‌های زودهنگام</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 class="card-title">
        <svg class="card-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
        اطلاعات حساب
      </h3>
      <pre id="rawUser" class="kv">{}</pre>
      <div style="margin-top:16px; display: flex; gap: 12px; flex-wrap: wrap;">
        <a class="btn btn-secondary" href="/">بازگشت به سایت</a>
        <button id="refreshData" class="btn btn-outline">به‌روزرسانی اطلاعات</button>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let favorites = [];
    let myServers = [];

    async function fetchAuth() {
      try {
        const res = await fetch('/api/auth/status', { credentials: 'include' });
        const data = await res.json().catch(() => ({}));
        return data;
      } catch { return { authenticated: false }; }
    }

    async function loadFavorites() {
      try {
        const res = await fetch('/api/favorites', { credentials: 'include' });
        if (res.ok) {
          favorites = await res.json();
          renderFavorites();
          updateStats();
        }
      } catch (e) {
        console.error('خطا در بارگذاری علاقه‌مندی‌ها:', e);
      }
    }

    function renderFavorites() {
      const container = document.getElementById('favoritesList');
      const emptyState = document.getElementById('favorites');
      
      if (favorites.length === 0) {
        emptyState.style.display = 'block';
        container.innerHTML = '';
        return;
      }
      
      emptyState.style.display = 'none';
      container.innerHTML = favorites.map(fav => `
        <div class="favorite-item" data-id="${fav.id}">
          <a href="${fav.url || '/'}" style="flex:1; text-decoration:none;">
            <div class="favorite-title">${fav.title}</div>
            <div class="favorite-type">${fav.type === 'article' ? 'مقاله' : 'کانفیگ'}</div>
          </a>
          <button class="remove-favorite" onclick="removeFavorite('${fav.id}')" title="حذف از علاقه‌مندی‌ها">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M18 6L6 18M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      `).join('');
    }

    async function removeFavorite(id) {
      try {
        const res = await fetch(`/api/favorites/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.ok) {
          favorites = favorites.filter(fav => fav.id !== id);
          renderFavorites();
          updateStats();
          showNotification('از علاقه‌مندی‌ها حذف شد', 'success');
        } else {
          showNotification('خطا در حذف از علاقه‌مندی‌ها', 'error');
        }
      } catch (e) {
        showNotification('خطا در ارتباط با سرور', 'error');
      }
    }

    function updateStats() {
      document.getElementById('favoritesCount').textContent = favorites.length;
      // در اینجا می‌توانید آمار دیگر را هم به‌روزرسانی کنید
      if (currentUser) {
        document.getElementById('downloadsCount').textContent = currentUser.downloads || 0;
        document.getElementById('articlesRead').textContent = currentUser.articles_read || 0;
        
        if (currentUser.created_at) {
          const memberSince = new Date(currentUser.created_at);
          const now = new Date();
          const diffTime = Math.abs(now - memberSince);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          document.getElementById('memberSince').textContent = `${diffDays} روز`;
        }
      }
    }

    function setPlanBadge(plan) {
      const badge = document.getElementById('planBadge');
      badge.classList.remove('plan-free','plan-gold');
      if (plan === 'gold') {
        badge.classList.add('plan-gold');
        badge.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          طرح: طلایی
        `;
        try { localStorage.setItem('user_plan', 'gold'); } catch {}
      } else {
        badge.classList.add('plan-free');
        badge.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 6v6l4 2"></path>
          </svg>
          طرح: رایگان
        `;
        try { localStorage.setItem('user_plan', 'free'); } catch {}
      }
    }

    async function init() {
      const a = await fetchAuth();
      if (!a.authenticated || !a.user) {
        window.location.href = '/';
        return;
      }
      
      currentUser = a.user;
      document.getElementById('userMeta').textContent = `شناسه تلگرام: ${currentUser.telegram_id}`;
      // Persisted GOLD fallback
      const persistedPlan = (localStorage.getItem('user_plan') || '').toLowerCase();
      setPlanBadge(currentUser.plan === 'gold' || persistedPlan === 'gold' ? 'gold' : 'free');
      document.getElementById('rawUser').textContent = JSON.stringify(currentUser, null, 2);
      
      await loadFavorites();
      await loadMyServers();
      updateStats();
    }

    // تابع نمایش اعلان
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'success' ? 'var(--success)' : 'var(--error)'};
        color: var(--bg);
        padding: 12px 24px;
        border-radius: var(--radius-lg);
        font-weight: 600;
        z-index: 10000;
        animation: slideInDown 0.3s ease;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOutUp 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    init();

    // سرورهای من (DNS)
    async function loadMyServers() {
      try {
        const res = await fetch('/api/scanner/my', { credentials: 'include' });
        const data = await res.json().catch(() => ({}));
        if (res.ok && Array.isArray(data?.servers)) {
          myServers = data.servers;
          renderMyServers();
        } else {
          myServers = [];
          renderMyServers();
        }
      } catch {
        myServers = [];
        renderMyServers();
      }
    }

    function renderMyServers() {
      const empty = document.getElementById('myServersEmpty');
      const list = document.getElementById('myServersList');
      if (!list || !empty) return;
      if (!myServers.length) {
        empty.style.display = 'block';
        list.innerHTML = '';
        return;
      }
      empty.style.display = 'none';
      list.innerHTML = myServers.map((s, idx) => `
        <div class="favorite-item" style="gap:12px; align-items:center;">
          <div style="flex:1;">
            <div class="favorite-title">${(s.country || '').toString()} <span class="country-code" style="margin-right:6px;">${(s.code||'').toUpperCase()}</span></div>
            <div class="favorite-type">DNS</div>
          </div>
          <code style="direction:ltr; user-select:all;">${s.address}</code>
          <button class="btn btn-primary" data-copy-address="${s.address}" title="کپی">کپی</button>
        </div>
      `).join('');
      // wire copy buttons
      list.querySelectorAll('[data-copy-address]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const ip = btn.getAttribute('data-copy-address');
          try { await navigator.clipboard.writeText(ip); showNotification('آدرس کپی شد', 'success'); } catch { showNotification('کپی ناموفق', 'error'); }
        });
      });
    }

    document.getElementById('refreshServers').addEventListener('click', async () => {
      const b = document.getElementById('refreshServers');
      b.disabled = true; b.textContent = 'در حال به‌روزرسانی...';
      await loadMyServers();
      b.disabled = false; b.textContent = 'به‌روزرسانی سرورها';
      showNotification('لیست سرورها به‌روزرسانی شد', 'success');
    });

    // فعال‌سازی حساب طلایی
    document.getElementById('btnActivateGold').addEventListener('click', async () => {
      const code = (document.getElementById('goldCode').value || '').trim();
      const msg = document.getElementById('goldMsg');
      if (!code) { 
        msg.textContent = 'کد را وارد کنید.';
        msg.style.color = 'var(--error)';
        return; 
      }
      
      msg.textContent = 'در حال بررسی...';
      msg.style.color = 'var(--text-muted)';
      
      try {
        const res = await fetch('/api/account/upgrade', {
          method: 'POST', 
          headers: { 'content-type': 'application/json' }, 
          credentials: 'include', 
          body: JSON.stringify({ code })
        });
        const data = await res.json().catch(() => ({}));
        
        if (res.ok && data.status === 'UPGRADED') {
          msg.textContent = '🎉 حساب طلایی با موفقیت فعال شد!';
          msg.style.color = 'var(--success)';
          setPlanBadge('gold');
          currentUser = data.user;
          document.getElementById('rawUser').textContent = JSON.stringify(data.user, null, 2);
          document.getElementById('goldCode').value = '';
          showNotification('حساب طلایی فعال شد!', 'success');
          try { localStorage.setItem('user_plan', 'gold'); } catch {}
        } else {
          const errorMsg = data.error === 'INVALID_CODE' ? 'کد نادرست است' : (data.error || 'خطا در فعال‌سازی');
          msg.textContent = errorMsg;
          msg.style.color = 'var(--error)';
          showNotification(errorMsg, 'error');
        }
      } catch { 
        msg.textContent = 'اشکال در ارتباط با سرور';
        msg.style.color = 'var(--error)';
        showNotification('اشکال در ارتباط با سرور', 'error');
      }
    });

    // به‌روزرسانی اطلاعات
    document.getElementById('refreshData').addEventListener('click', async () => {
      const btn = document.getElementById('refreshData');
      btn.disabled = true;
      btn.textContent = 'در حال به‌روزرسانی...';
      
      await init();
      
      btn.disabled = false;
      btn.textContent = 'به‌روزرسانی اطلاعات';
      showNotification('اطلاعات به‌روزرسانی شد', 'success');
    });

    // اضافه کردن استایل‌های انیمیشن
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideInDown {
        from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
      }
      @keyframes slideOutUp {
        from { transform: translateX(-50%) translateY(0); opacity: 1; }
        to { transform: translateX(-50%) translateY(-100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
