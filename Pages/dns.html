<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pro TooLs - دی ان اس (DNS)</title>
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>
  <div id="loading" class="loading-screen">
    <div class="loading-content">
      <div class="loading-logo">Pro TooLs</div>
      <div class="loading-spinner"></div>
      <p class="loading-text">در حال بارگذاری...</p>
    </div>
  </div>
  <div id="main-content" class="main-content hidden">
    <header class="header">
      <nav class="navbar">
        <div class="nav-brand"><a href="../index.html" class="logo-link" aria-label="Pro TooLs"><img src="../icons/Logo.svg" alt="Pro TooLs" class="logo-img" /></a></div>
        <div class="nav-actions" role="group" aria-label="ورود و حساب کاربری">
          <a id="headerDashboardLink" href="/dashboard/user/" class="btn btn-secondary hide" style="display:none;">حساب کاربری</a>
          <button id="openAuthModalHeaderBtn" class="btn btn-primary">ورود / ثبت‌نام</button>
        </div>
        <ul class="nav-menu">
          <li><a class="nav-link" href="../index.html"><span class="nav-icon" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 10.5L12 3l9 7.5V21a1 1 0 0 1-1 1h-5a1 1 0 0 1-1-1v-5H10v5a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-10.5z" fill="currentColor"/></svg></span><span>خانه</span></a></li>
          <li class="dropdown">
            <a href="#" class="nav-link dropdown-toggle"><span class="nav-icon" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 5h18v4H3V5zm0 5h18v4H3v-4zm0 5h18v4H3v-4z" fill="currentColor"/></svg></span><span>سیستم عامل</span><span class="dropdown-arrow">▼</span></a>
            <div class="dropdown-menu">
              <a href="ios/" class="dropdown-item">
                <span class="item-icon" aria-hidden="true">
                  <img src="../icons/apple.svg" alt="Apple" />
                </span>
                آیفون
              </a>
              <a href="android/" class="dropdown-item">
                <span class="item-icon" aria-hidden="true">
                  <img src="../icons/android.svg" alt="Android" />
                </span>
                اندروید
              </a>
              <a href="windows/" class="dropdown-item">
                <span class="item-icon" aria-hidden="true">
                  <img src="../icons/windows.svg" alt="Windows" />
                </span>
                ویندوز
              </a>
            </div>
          </li>
          <li class="dropdown">
            <a href="#" class="nav-link dropdown-toggle"><span class="nav-icon" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 5h8v6H3V5zm10 0h8v6h-8V5zM3 13h8v6H3v-6zm10 0h8v6h-8v-6z" fill="currentColor"/></svg></span><span>پنل ها</span><span class="dropdown-arrow">▼</span></a>
            <div class="dropdown-menu">
              <a href="web-panel/" class="dropdown-item">
                <span class="item-icon" aria-hidden="true">
                  <img src="../icons/html-5.svg" alt="HTML5" />
                </span>
                سایتی
              </a>
              <a href="python-panel.html" class="dropdown-item">
                <span class="item-icon" aria-hidden="true">
                  <img src="../icons/python.svg" alt="Python" />
                </span>
                پایتونی
              </a>
            </div>
          </li>
          <li class="dropdown">
            <a href="#" class="nav-link dropdown-toggle"><span class="nav-icon" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 4h16v6H4V4zm0 10h16v6H4v-6zm3 1v2h2v-2H7zM7 5v2h2V5H7z" fill="currentColor"/></svg></span><span>سرور اختصاصی</span><span class="dropdown-arrow">▼</span></a>
            <div class="dropdown-menu">
              <a href="openvpn.html" class="dropdown-item">
                <span class="item-icon" aria-hidden="true">
                  <img src="../icons/openvpn.svg" alt="OpenVPN" />
                </span>
                اوپن وی پی ان
              </a>
              <a href="dns.html" class="dropdown-item">
                <span class="item-icon" aria-hidden="true">
                  <img src="../icons/dns.png" alt="DNS" />
                </span>
                دی ان اس
              </a>
              <a href="wireguard.html" class="dropdown-item">
                <span class="item-icon" aria-hidden="true">
                  <img src="../icons/wireguard.svg" alt="WireGuard" />
                </span>
                وایرگارد
              </a>
            </div>
          </li>
          <li><a class="nav-link" href="about.html"><span class="nav-icon" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 12a5 5 0 100-10 5 5 0 000 10zm-7 9a7 7 0 0114 0H5z" fill="currentColor"/></svg></span><span>درباره ما</span></a></li>
        </ul>
        <div class="hamburger"><span></span><span></span><span></span></div>
      </nav>
    </header>
    <div class="scroll-progress" aria-hidden="true"><span></span></div>

    <main class="section">
      <div class="container">
        <div class="section-header" style="margin-bottom: 20px;">
          <h2 class="section-title" style="margin-bottom: 12px;">دی ان اس (DNS)</h2>
          <div class="platform-badge" aria-hidden="true">
            <img src="../icons/dns.png" alt="DNS" />
          </div>
          <p class="section-subtitle">DNS guides, servers and tips</p>
        </div>

        <!-- Server Scanner Section - Moved to top -->
        <section class="section" style="margin-bottom: 16px;">
          <div class="section-header" style="margin-bottom: 16px;">
            <h3 class="section-title" style="margin-bottom: 8px;">اسکنر سرور (DNS)</h3>
            <p class="section-subtitle">لیست کشورها و موجودی سرورها. دریافت هر آدرس برای حداکثر دو کاربر مجاز است.</p>
          </div>
          <div id="scannerCountries" class="app-grid"></div>
        </section>

        <!-- Articles Section - Moved below scanner -->
        <section class="section" style="padding-top: 8px;">
          <div class="section-header" style="margin-bottom: 16px;">
            <h3 class="section-title" style="margin-bottom: 8px;">مقالات و راهنماها</h3>
            <p class="section-subtitle">آموزش‌های کامل تنظیم و استفاده از DNS</p>
          </div>
          <div class="articles-grid">
            <div id="dnsArticles"></div>
          </div>
        </section>
      </div>
    </main>

    <!-- Modal Viewer -->
    <div class="modal-backdrop" id="dnsModal">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title" id="dnsModalTitle">سرور های DNS</div>
          <div style="display:flex; align-items:center; gap:.5rem;">
            <div class="modal-close" id="dnsModalClose" aria-label="بستن">×</div>
          </div>
        </div>
        <div class="modal-body" id="dnsModalBody">
          <div class="dns-servers-grid">
            <div class="dns-server-card" data-provider="گوگل" data-primary="8.8.8.8" data-secondary="8.8.4.4">
              <div class="dns-server-header">
                <div class="dns-server-icon">🌐</div>
                <div class="dns-server-name">گوگل</div>
                <div class="dns-server-status online">آنلاین</div>
              </div>
              <div class="dns-server-ips">
                <div class="dns-ip primary" data-ip="8.8.8.8">
                  <span class="ip-label">اصلی:</span>
                  <span class="ip-value">8.8.8.8</span>
                  <button class="copy-btn" title="کپی">📋</button>
                </div>
                <div class="dns-ip secondary" data-ip="8.8.4.4">
                  <span class="ip-label">ثانویه:</span>
                  <span class="ip-value">8.8.4.4</span>
                  <button class="copy-btn" title="کپی">📋</button>
                </div>
              </div>
              <div class="dns-server-description">سرویس DNS سریع و قابل اعتماد گوگل</div>
            </div>

            <div class="dns-server-card" data-provider="کلودفلر" data-primary="1.1.1.1" data-secondary="1.0.0.1">
              <div class="dns-server-header">
                <div class="dns-server-icon">☁️</div>
                <div class="dns-server-name">کلودفلر</div>
                <div class="dns-server-status online">آنلاین</div>
              </div>
              <div class="dns-server-ips">
                <div class="dns-ip primary" data-ip="1.1.1.1">
                  <span class="ip-label">اصلی:</span>
                  <span class="ip-value">1.1.1.1</span>
                  <button class="copy-btn" title="کپی">📋</button>
                </div>
                <div class="dns-ip secondary" data-ip="1.0.0.1">
                  <span class="ip-label">ثانویه:</span>
                  <span class="ip-value">1.0.0.1</span>
                  <button class="copy-btn" title="کپی">📋</button>
                </div>
              </div>
              <div class="dns-server-description">سریع‌ترین DNS عمومی جهان با تمرکز بر حریم خصوصی</div>
            </div>

            <div class="dns-server-card" data-provider="رادار گیم" data-primary="10.202.10.10" data-secondary="10.202.10.11">
              <div class="dns-server-header">
                <div class="dns-server-icon">🎮</div>
                <div class="dns-server-name">رادار گیم</div>
                <div class="dns-server-status online">آنلاین</div>
              </div>
              <div class="dns-server-ips">
                <div class="dns-ip primary" data-ip="10.202.10.10">
                  <span class="ip-label">اصلی:</span>
                  <span class="ip-value">10.202.10.10</span>
                  <button class="copy-btn" title="کپی">📋</button>
                </div>
                <div class="dns-ip secondary" data-ip="10.202.10.11">
                  <span class="ip-label">ثانویه:</span>
                  <span class="ip-value">10.202.10.11</span>
                  <button class="copy-btn" title="کپی">📋</button>
                </div>
              </div>
              <div class="dns-server-description">DNS مخصوص گیمرها با تاخیر کم</div>
            </div>

            <div class="dns-server-card" data-provider="الکترو" data-primary="78.157.42.100" data-secondary="78.157.42.101">
              <div class="dns-server-header">
                <div class="dns-server-icon">⚡</div>
                <div class="dns-server-name">الکترو</div>
                <div class="dns-server-status online">آنلاین</div>
              </div>
              <div class="dns-server-ips">
                <div class="dns-ip primary" data-ip="78.157.42.100">
                  <span class="ip-label">اصلی:</span>
                  <span class="ip-value">78.157.42.100</span>
                  <button class="copy-btn" title="کپی">📋</button>
                </div>
                <div class="dns-ip secondary" data-ip="78.157.42.101">
                  <span class="ip-label">ثانویه:</span>
                  <span class="ip-value">78.157.42.101</span>
                  <button class="copy-btn" title="کپی">📋</button>
                </div>
              </div>
              <div class="dns-server-description">سرویس DNS سریع و امن الکترو</div>
            </div>

            <div class="dns-server-card" data-provider="اوپن دی ان اس" data-primary="208.67.222.222" data-secondary="208.67.220.220">
              <div class="dns-server-header">
                <div class="dns-server-icon">🛡️</div>
                <div class="dns-server-name">اوپن دی ان اس</div>
                <div class="dns-server-status online">آنلاین</div>
              </div>
              <div class="dns-server-ips">
                <div class="dns-ip primary" data-ip="208.67.222.222">
                  <span class="ip-label">اصلی:</span>
                  <span class="ip-value">208.67.222.222</span>
                  <button class="copy-btn" title="کپی">📋</button>
                </div>
                <div class="dns-ip secondary" data-ip="208.67.220.220">
                  <span class="ip-label">ثانویه:</span>
                  <span class="ip-value">208.67.220.220</span>
                  <button class="copy-btn" title="کپی">📋</button>
                </div>
              </div>
              <div class="dns-server-description">DNS امن با فیلتر محتوای مخرب</div>
            </div>

            <div class="dns-server-card" data-provider="شکن رایگان" data-primary="178.22.122.100" data-secondary="185.51.200.2">
              <div class="dns-server-header">
                <div class="dns-server-icon">🔓</div>
                <div class="dns-server-name">شکن رایگان</div>
                <div class="dns-server-status online">آنلاین</div>
              </div>
              <div class="dns-server-ips">
                <div class="dns-ip primary" data-ip="178.22.122.100">
                  <span class="ip-label">اصلی:</span>
                  <span class="ip-value">178.22.122.100</span>
                  <button class="copy-btn" title="کپی">📋</button>
                </div>
                <div class="dns-ip secondary" data-ip="185.51.200.2">
                  <span class="ip-label">ثانویه:</span>
                  <span class="ip-value">185.51.200.2</span>
                  <button class="copy-btn" title="کپی">📋</button>
                </div>
              </div>
              <div class="dns-server-description">DNS رایگان برای دور زدن فیلترینگ</div>
            </div>

            <div class="dns-server-card" data-provider="شکن پرو" data-primary="178.22.122.101" data-secondary="185.51.200.1">
              <div class="dns-server-header">
                <div class="dns-server-icon">🔐</div>
                <div class="dns-server-name">شکن پرو</div>
                <div class="dns-server-status online">آنلاین</div>
              </div>
              <div class="dns-server-ips">
                <div class="dns-ip primary" data-ip="178.22.122.101">
                  <span class="ip-label">اصلی:</span>
                  <span class="ip-value">178.22.122.101</span>
                  <button class="copy-btn" title="کپی">📋</button>
                </div>
                <div class="dns-ip secondary" data-ip="185.51.200.1">
                  <span class="ip-label">ثانویه:</span>
                  <span class="ip-value">185.51.200.1</span>
                  <button class="copy-btn" title="کپی">📋</button>
                </div>
              </div>
              <div class="dns-server-description">DNS پریمیوم با سرعت بالا</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer">
      <div class="container">
        <div class="footer-bottom">
          <p>© 2025 TooLs. این سایت با کمک هوش مصنوعی در حال توسعه است و ممکن است برخی مطالب به صورت خودکار منتشر شده باشند.</p>
        </div>
      </div>
    </footer>
  </div>
  <script src="../script.js"></script>
  <script>
    // DNS modal interactions
    (function(){
      const modal = document.getElementById('dnsModal');
      const titleEl = document.getElementById('dnsModalTitle');
      const bodyEl = document.getElementById('dnsModalBody');
      const closeEl = document.getElementById('dnsModalClose');

      // 1) Load DNS articles dynamically from JSON
      const articlesContainer = document.getElementById('dnsArticles');
      if (articlesContainer) {
        fetch('../Articles/dns.json', { cache: 'no-cache' })
          .then(r => r.ok ? r.json() : [])
          .then(list => {
            if (!Array.isArray(list)) return;
            const frag = document.createDocumentFragment();

            list.forEach(item => {
              const card = document.createElement('div');
              card.className = 'glass-card article-card';
              // Make article open the DNS modal on click (for now)
              card.setAttribute('data-modal', 'dns-servers');

              // Robust cover resolution: try several locations
              const name = (item.cover || '').split('/').pop() || '';
              const candidates = [];
              if (item.cover && item.cover.trim()) {
                // as provided
                candidates.push(item.cover.trim());
                // common alternates
                candidates.push(`cover/${name}`);
                candidates.push(`covers/${name}`);
                candidates.push(`../Articles/covers/${name}`);
              }
              candidates.push('../icons/dns.png');
              card.innerHTML = `
                <div class="article-cover"><img alt="${item.title || ''}" data-role="cover-img"/></div>
                <div class="article-title">${item.title || ''}</div>
                <div class="article-summary">${item.summary || ''}</div>
              `;

              const img = card.querySelector('img[data-role="cover-img"]');
              if (img) {
                let idx = 0;
                const tryNext = () => {
                  if (idx >= candidates.length) return;
                  const src = candidates[idx++];
                  img.onerror = tryNext;
                  img.src = src;
                };
                tryNext();
              }

              frag.appendChild(card);
            });

            articlesContainer.replaceChildren(frag);
          })
          .catch(() => {
            // Fallback: show nothing on error
          });
      }

      // 2) Only open modal for cards that explicitly opt-in via data-modal
      function bindArticleClicks(){
        document.querySelectorAll('.article-card').forEach(card => {
          card.addEventListener('click', () => {
            if (card.hasAttribute('data-modal')) {
              modal.classList.add('active');
              setTimeout(() => { initializeCopyButtons(); }, 100);
            }
          });
        });
      }
      // Bind initially and after possible dynamic render
      bindArticleClicks();
      const observer = new MutationObserver(() => bindArticleClicks());
      const articlesWrap = document.querySelector('.articles-grid');
      if (articlesWrap) observer.observe(articlesWrap, { childList: true, subtree: true });

      // (Replaced by bindArticleClicks)

      // Copy IP address functionality
      function initializeCopyButtons() {
        document.querySelectorAll('.copy-btn').forEach(btn => {
          // Remove existing listeners
          btn.replaceWith(btn.cloneNode(true));
        });
        
        document.querySelectorAll('.copy-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const ipElement = btn.parentElement;
            const ip = ipElement.getAttribute('data-ip');
            
            try {
              await navigator.clipboard.writeText(ip);
              
              // Visual feedback
              const originalText = btn.textContent;
              btn.textContent = '✅';
              btn.style.background = '#4CAF50';
              
              setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
              }, 1500);
              
              // Show toast notification
              showToast(`IP ${ip} کپی شد!`);
            } catch (err) {
              // Fallback for older browsers
              const textArea = document.createElement('textarea');
              textArea.value = ip;
              document.body.appendChild(textArea);
              textArea.select();
              document.execCommand('copy');
              document.body.removeChild(textArea);
              
              showToast(`IP ${ip} کپی شد!`);
            }
          });
        });
      }

      // Toast notification function
      function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.textContent = message;
        toast.style.cssText = `
          position: fixed;
          top: 100px;
          right: 20px;
          background: rgba(0, 0, 0, 0.9);
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          border: 1px solid var(--border);
          backdrop-filter: blur(10px);
          z-index: 10001;
          font-family: 'DanaFaNum', sans-serif;
          font-size: 14px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          animation: slideInRight 0.3s ease;
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.animation = 'slideOutRight 0.3s ease';
          setTimeout(() => {
            if (document.body.contains(toast)) {
              document.body.removeChild(toast);
            }
          }, 300);
        }, 2000);
      }

      // Close modal functionality
      function closeModal(){ modal.classList.remove('active'); }
      closeEl.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

      // Add CSS animations for toast and country cards
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
        
        /* Enhanced Country Card Styles */
        .country-card {
          background: rgba(255, 255, 255, 0.05) !important;
          backdrop-filter: blur(20px) !important;
          border: 1px solid rgba(255, 255, 255, 0.1) !important;
          border-radius: 16px !important;
          padding: 20px !important;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
          position: relative;
          overflow: hidden;
        }
        
        .country-card::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 1px;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        }
        
        .country-card:hover {
          transform: translateY(-4px) !important;
          background: rgba(255, 255, 255, 0.08) !important;
          border-color: rgba(255, 255, 255, 0.2) !important;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important;
        }
        
        .country-card-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 16px;
          gap: 16px;
        }
        
        .country-info-section {
          display: flex;
          align-items: center;
          gap: 12px;
          flex: 1;
        }
        
        .country-flag-container {
          width: 48px;
          height: 36px;
          border-radius: 8px;
          overflow: hidden;
          background: rgba(255, 255, 255, 0.1);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.15);
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .country-flag-img {
          width: 100%;
          height: 100%;
          object-fit: cover;
        }
        
        .country-flag-emoji {
          font-size: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        
        .country-details {
          flex: 1;
        }
        
        .country-name {
          font-size: 18px;
          font-weight: 700;
          color: var(--text);
          margin: 0 0 4px 0;
          line-height: 1.2;
        }
        
        .country-code {
          font-size: 12px;
          color: var(--text-secondary);
          font-weight: 500;
          background: rgba(255, 255, 255, 0.1);
          padding: 2px 8px;
          border-radius: 12px;
          backdrop-filter: blur(10px);
        }
        
        .country-stats-section {
          flex-shrink: 0;
        }
        
        .stat-glass-container {
          display: flex;
          gap: 8px;
        }
        
        .stat-glass-item {
          background: rgba(255, 255, 255, 0.08);
          backdrop-filter: blur(15px);
          border: 1px solid rgba(255, 255, 255, 0.12);
          border-radius: 12px;
          padding: 8px 12px;
          text-align: center;
          min-width: 60px;
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
        }
        
        .stat-glass-item::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
          transition: left 0.5s ease;
        }
        
        .stat-glass-item:hover::before {
          left: 100%;
        }
        
        .stat-glass-item:hover {
          background: rgba(255, 255, 255, 0.12);
          border-color: rgba(255, 255, 255, 0.2);
          transform: translateY(-2px);
        }
        
        .stat-number {
          font-size: 20px;
          font-weight: 700;
          line-height: 1;
          margin-bottom: 2px;
        }
        
        .stat-label {
          font-size: 10px;
          font-weight: 500;
          opacity: 0.8;
          line-height: 1;
        }
        
        .total-stat .stat-number { color: var(--text); }
        .available-stat .stat-number { color: #4CAF50; }
        .allocated-stat .stat-number { color: #FF9800; }
        
        .country-card-footer {
          margin-top: 16px;
        }
        
        .server-status-bar {
          width: 100%;
          height: 4px;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 2px;
          overflow: hidden;
          margin-bottom: 12px;
        }
        
        .status-bar-fill {
          height: 100%;
          background: linear-gradient(90deg, #4CAF50, #8BC34A);
          border-radius: 2px;
          transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
          box-shadow: 0 0 8px rgba(76, 175, 80, 0.4);
        }
        
        .country-action-btn {
          width: 100%;
          display: flex !important;
          align-items: center;
          justify-content: center;
          gap: 8px;
          padding: 12px 16px !important;
          border-radius: 12px !important;
          font-weight: 600;
          background: rgba(76, 175, 80, 0.2) !important;
          border: 1px solid rgba(76, 175, 80, 0.3) !important;
          backdrop-filter: blur(10px);
          transition: all 0.3s ease !important;
        }
        
        .country-action-btn:hover:not(:disabled) {
          background: rgba(76, 175, 80, 0.3) !important;
          border-color: rgba(76, 175, 80, 0.5) !important;
          transform: translateY(-2px) !important;
          box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3) !important;
        }
        
        .country-action-btn:disabled {
          background: rgba(255, 255, 255, 0.05) !important;
          border-color: rgba(255, 255, 255, 0.1) !important;
          color: var(--text-secondary) !important;
          cursor: not-allowed;
        }
        
        .btn-icon {
          font-size: 16px;
        }
        
        .btn-text {
          font-size: 14px;
        }
        
        @media (max-width: 768px) {
          .country-card-header {
            flex-direction: column;
            gap: 12px;
          }
          
          .country-stats-section {
            width: 100%;
          }
          
          .stat-glass-container {
            justify-content: space-between;
          }
          
          .stat-glass-item {
            flex: 1;
            min-width: auto;
          }
        }
      `;
      document.head.appendChild(style);

      // 3) Server Scanner UI
      const countriesWrap = document.getElementById('scannerCountries');
      if (countriesWrap) {
        loadScanner();

        async function loadScanner() {
          // 1) Try dedicated scanner API
          try {
            const res = await fetch('/api/scanner', { cache: 'no-cache' });
            if (res.ok) {
              const data = await res.json();
              if (data && (Array.isArray(data.countries) || data.serversByCountry)) {
                renderCountries(data?.countries || [], data?.serversByCountry || {});
                return;
              }
            }
          } catch {}

          // 2) Fallback: read from KV key scanner/countries.json written by admin panel
          try {
            const url = new URL('/api/kv/get', location.origin);
            url.searchParams.set('key', 'scanner/countries.json');
            const resKV = await fetch(url.toString(), { cache: 'no-cache' });
            if (resKV.ok) {
              const text = await resKV.text();
              try {
                const kvData = JSON.parse(text || '{}');
                const countries = Array.isArray(kvData?.countries) ? kvData.countries : [];
                // Build serversByCountry from plain IPs with all available by default
                const serversByCountry = {};
                countries.forEach(c => {
                  const ips = Array.isArray(c?.servers) ? c.servers : [];
                  serversByCountry[c.code] = ips.map(ip => ({ ip, allocated: false }));
                });
                renderCountries(countries, serversByCountry);
                return;
              } catch {}
            }
          } catch {}

          // 3) As last resort, render defaults
          renderCountries([], {});
        }

        function flagEmoji(cc) {
          if (!cc || cc.length !== 2) return '🌐';
          const codePoints = [...cc.toUpperCase()].map(c => 0x1F1E6 - 'A'.charCodeAt(0) + c.charCodeAt(0));
          return String.fromCodePoint(...codePoints);
        }

        // Enhanced flag loading with multiple fallbacks
        function loadCountryFlag(element, countryCode) {
          const flagSources = [
            `https://flagcdn.com/w80/${countryCode.toLowerCase()}.png`,
            `https://flagcdn.com/w40/${countryCode.toLowerCase()}.png`,
            `https://flagpedia.net/data/flags/w580/${countryCode.toLowerCase()}.png`,
            `https://flagpedia.net/data/flags/mini/${countryCode.toLowerCase()}.png`
          ];
          
          let currentIndex = 0;
          
          function tryNextSource() {
            if (currentIndex >= flagSources.length) {
              // All sources failed, show emoji fallback
              element.innerHTML = `<div style="font-size:28px;">${flagEmoji(countryCode)}</div>`;
              return;
            }
            
            const img = document.createElement('img');
            img.src = flagSources[currentIndex];
            img.alt = `${countryCode} flag`;
            img.style.cssText = 'width: 40px; height: 30px; border-radius: 4px; object-fit: cover; box-shadow: 0 2px 8px rgba(0,0,0,0.2);';
            
            img.onload = () => {
              element.innerHTML = '';
              element.appendChild(img);
            };
            
            img.onerror = () => {
              currentIndex++;
              tryNextSource();
            };
          }
          
          tryNextSource();
        }

        function renderCountries(list, byCountry) {
          const frag = document.createDocumentFragment();
          
          // If no data from API, show default countries
          if (!list || list.length === 0) {
            list = [
              { code: 'GB', name: 'انگلستان' },
              { code: 'DE', name: 'آلمان' }
            ];
          }
          
          list.forEach(item => {
            // Calculate stats dynamically from serversByCountry if provided
            const servers = (byCountry && item?.code && Array.isArray(byCountry[item.code])) ? byCountry[item.code] : [];
            const total = servers.length || (item.total || 0);
            const available = servers.length
              ? servers.filter(s => {
                  const st = (s?.status || '').toString().toLowerCase();
                  const allocated = Boolean(s?.allocated) || st === 'allocated' || st === 'busy' || st === 'used';
                  return !allocated;
                }).length
              : (item.available || 0);
            const allocatedCount = Math.max(0, total - available);
            const card = document.createElement('div');
            card.className = 'glass-card country-card';
            card.innerHTML = `
              <div class="country-card-header">
                <div class="country-info-section">
                  <div class="country-flag-container">
                    <img src="https://flagcdn.com/w80/${item.code.toLowerCase()}.png" 
                         alt="${item.name} flag" 
                         class="country-flag-img"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"/>
                    <div class="country-flag-emoji" style="display:none;">${flagEmoji(item.code)}</div>
                  </div>
                  <div class="country-details">
                    <h4 class="country-name">${item.name || item.code || 'کشور'}</h4>
                    <span class="country-code">${item.code}</span>
                  </div>
                </div>
                
                <div class="country-stats-section">
                  <div class="stat-glass-container">
                    <div class="stat-glass-item total-stat">
                      <div class="stat-number">${total}</div>
                      <div class="stat-label">کل سرور</div>
                    </div>
                    <div class="stat-glass-item available-stat">
                      <div class="stat-number">${available}</div>
                      <div class="stat-label">آزاد</div>
                    </div>
                    <div class="stat-glass-item allocated-stat">
                      <div class="stat-number">${allocatedCount}</div>
                      <div class="stat-label">اشغال</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="country-card-footer">
                <div class="server-status-bar">
                  <div class="status-bar-fill" style="width: ${total > 0 ? (available / total * 100) : 0}%"></div>
                </div>
                <button class="btn btn-primary scan-allocate-btn country-action-btn" data-country="${item.code || item.name}" 
                        ${available === 0 ? 'disabled' : ''}>
                  <span class="btn-icon">🌐</span>
                  <span class="btn-text">${available === 0 ? 'سرور موجود نیست' : 'دریافت سرور'}</span>
                </button>
              </div>
            `;
            frag.appendChild(card);
          });
          countriesWrap.replaceChildren(frag);

          // bind allocate buttons
          countriesWrap.querySelectorAll('.scan-allocate-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const country = btn.getAttribute('data-country') || '';
              btn.disabled = true;
              try {
                // Check auth status
                const s = await fetch('/api/auth/status', { credentials: 'include' }).then(r=>r.json()).catch(()=>({authenticated:false}));
                if (!s?.authenticated) {
                  // redirect to login/register
                  window.location.href = '/index.html#register?mode=login';
                  return;
                }
                const res = await fetch('/api/scanner/allocate', {
                  method: 'POST',
                  headers: { 'content-type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify({ country })
                });
                const data = await res.json().catch(()=>({}));
                if (res.ok && data?.address) {
                  showToast(`سرور شما: ${data.address}`);
                  try { await navigator.clipboard.writeText(data.address); } catch {}
                } else {
                  showToast(data?.error === 'NO_AVAILABLE_SERVER' ? 'سرور آزاد موجود نیست' : 'خطا در دریافت سرور');
                }
              } finally {
                btn.disabled = false;
                // refresh counts
                loadScanner();
              }
            });
          });
        }
      }
    })();
  </script>
</body>
</html>
